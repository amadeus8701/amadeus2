<!DOCTYPE html>
<html>
<head>
    <title>Image Viewer</title>
</head>
<body>
    <h1>Image Viewer</h1>

    <!-- 이미지를 표시할 div 요소 -->
    <div id="image-container">
        <img id="image" src="{% url 'poll_image' %}" alt="">
    </div>
    
    <!-- 새로운 이미지 경로를 보여줄 로그 영역 -->
    <h2>Real-Time Image Log</h2>
    <ul id="image-log-list" style="overflow-y: scroll; max-height: 300px;">
        <!-- 이전 로그 항목들을 여기에 추가 -->
    </ul>
    
    <script>
        let oldImagePath = ""; // 초기 이미지 경로를 저장합니다.
        let logCount = 0; // 로그 항목 개수를 추적합니다.

        function addImageLogMessage(message) {
            const logList = document.getElementById('image-log-list');
            const logItem = document.createElement('li');
            logItem.textContent = message;
            logList.appendChild(logItem);
            logCount++;
            
            // 로그 항목이 15개를 초과하면 첫 번째 항목을 제거합니다.
            if (logCount > 15) {
                logList.removeChild(logList.firstChild);
                logCount--;
            }
            
            // 스크롤을 항상 가장 아래로 유지합니다.
            logList.scrollTop = logList.scrollHeight;
        }

        function pollImage() {
            // 이미지 파일 경로를 가져오기 위해 AJAX 요청을 보냅니다.
            fetch('/poll_image/', { method: 'GET' })
                .then(response => response.text())
                .then(newImagePath => {
                    // 새로운 이미지 경로가 이전 경로와 다르다면 페이지를 업데이트하고 로그에 기록합니다.
                    if (newImagePath !== oldImagePath) {
                        const message = `Image Updated: ${oldImagePath} => ${newImagePath}`;
                        addImageLogMessage(message);

                        const image = document.getElementById('image');
                        image.src = newImagePath;
                        oldImagePath = newImagePath; // 변경된 경로를 저장합니다.
                    }
                });
        }

        // 1초마다 이미지 파일 변경을 확인하기 위해 폴링 함수를 호출합니다.
        setInterval(pollImage, 1000);
    </script>
</body>
</html>
